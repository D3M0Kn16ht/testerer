// ==Seanime Extension==
// @name         Русский интерфейс (Russian UI)
// @description  Перевод основных элементов интерфейса Seanime на русский язык
// @version      1.0.1
// @author       You
// @icon         https://img.icons8.com/fluency/48/russia-circular.png
// @type         ui
// @target       seanime
// ==/Seanime Extension==

function init() {
    $ui.register((ctx) => {

        // ────────────────────────────────────────────────
        // Словарь перевода (только русский)
        // ────────────────────────────────────────────────
        const ru = {
            "My library": "Моя библиотека",
            "Schedule": "Расписание",
            "Manga": "Манга",
            "Discover": "Обзор",
            "Extensions": "Расширения",
            "Settings": "Настройки",
            "Manage your plugins and content providers.": "Управление плагинами и источниками контента.",
            "Check for updates": "Проверить обновления",
            "Add an extension/plugin": "Добавить расширение / плагин",
            "Playground": "Песочница",
            "Marketplace": "Магазин",
            "Built-in": "Встроенные",
            "Browse and install extensions from the repository.": "Просматривайте и устанавливайте расширения из репозитория.",
            "Source:": "Источник:",
            "Official repository": "Официальный репозиторий",
            "All types": "Все типы",
            "All Languages": "Все языки",
            "Refresh": "Обновить",
            "Refresh AniList": "Обновить AniList",
            "Search extensions...": "Поиск расширений...",
            "Apply Default": "Применить по умолчанию",
            "Cancel": "Отмена",
            "Save": "Сохранить",
            "Enter the URL of the repository JSON file.": "Введите URL JSON-файла репозитория.",
            "Code": "Код",
            "You can edit the code of the extension here.": "Здесь можно редактировать код расширения.",
            "Info": "Информация",
            "Preferences": "Настройки",
            "You can edit the preferences for this extension here.": "Здесь можно изменить настройки этого расширения.",
            "Default:": "По умолчанию:",
            "Author:": "Автор:",
            "Language:": "Язык:",
            "Programming language:": "Язык программирования:",
            "Uninstall": "Удалить",
            "Grant": "Разрешить",
            "Permissions required": "Требуемые разрешения",
            "Grant permissions": "Предоставить разрешения",
            "The plugin": "Плагин",
            "is requesting the following permissions:": "запрашивает следующие разрешения:",
            "Remove": "Удалить",
            "This action cannot be undone.": "Это действие нельзя отменить.",
            "Confirm": "Подтвердить",
            "Library": "Библиотека",
            "Scan summaries": "Результаты сканирования",
            "Search": "Поиск",
            "Sync now": "Синхронизировать сейчас",
            "Save media": "Сохранить медиа",
            "Local storage size:": "Размер локального хранилища:",
            "Update local data": "Обновить локальные данные",
            "Upload local changes to AniList": "Загрузить локальные изменения в AniList",
            "Save locally": "Сохранить локально",
            "Current": "Текущие",
            "Your library is empty": "Ваша библиотека пуста",
            "Trending this season": "Популярное в этом сезоне",
            "Watch": "Смотреть",
            "Releasing": "Выходит",
            "days": "дней",
            "Add to list": "Добавить в список",
            "Continue reading": "Продолжить чтение",
            "Downloads": "Загрузки",
            "Score": "Оценка",
            "Progress": "Прогресс",
            "Start date": "Дата начала",
            "Completion date": "Дата завершения",
            "Total rereads": "Всего перечитываний",
            "Unread chapters only": "Только непрочитанные главы",
            "Preview": "Предпросмотр",
            "Advanced Search": "Расширенный поиск",
            "Aired Recently": "Недавно вышедшие",
            // жанры
            "Action": "Экшен",
            "Adventure": "Приключения",
            "Comedy": "Комедия",
            "Drama": "Драма",
            "Fantasy": "Фэнтези",
            "Horror": "Ужасы",
            "Music": "Музыка",
            "Mystery": "Детектив",
            "Psychological": "Психологическое",
            "Romance": "Романтика",
            "Sci-Fi": "Научная фантастика",
            "Slice of Life": "Повседневность",
            "Sports": "Спорт",
            "Supernatural": "Сверхъестественное",
            "Thriller": "Триллер",
            // дополнительные полезные строки (можно дополнять)
            "Todo": "К выполнению",
            "Status": "Статус",
            "Indicate watched episodes": "Отмечать просмотренные серии",
            "Disable image transitions": "Отключить анимацию перехода изображений",
            "Coming up next": "Далее"
        };

        // ────────────────────────────────────────────────
        // Функция перевода
        // ────────────────────────────────────────────────
        function injectTranslation() {
            const script = document.createElement("script");
            script.type = "text/javascript";
            script.textContent = `
                (function() {
                    const tr = ${JSON.stringify(ru)};
                    const MAX = 180;

                    function norm(t) {
                        return (t || "").toLowerCase()
                            .replace(/\\s+/g, " ")
                            .replace(/\\u00A0/g, " ")
                            .replace(/[.,:;!?]$/, "")
                            .trim();
                    }

                    function walk(node) {
                        if (node.nodeType === Node.TEXT_NODE) {
                            const txt = node.textContent.trim();
                            if (!txt || txt.length > MAX) return;
                            const key = norm(txt);
                            if (tr[key]) {
                                node.textContent = tr[key];
                            }
                            return;
                        }

                        if (node.nodeType !== Node.ELEMENT_NODE) return;

                        // атрибуты
                        ["placeholder", "title", "aria-label", "value"].forEach(attr => {
                            let val = node.getAttribute(attr);
                            if (!val) return;
                            val = val.trim();
                            if (val.length > MAX) return;
                            const k = norm(val);
                            if (tr[k]) node.setAttribute(attr, tr[k]);
                        });

                        for (let child of node.childNodes) walk(child);
                    }

                    // первый запуск
                    walk(document.body);

                    // наблюдатель за новыми элементами и изменениями текста
                    const observer = new MutationObserver(muts => {
                        for (const m of muts) {
                            if (m.type === "childList") {
                                m.addedNodes.forEach(n => walk(n));
                            } else if (m.type === "characterData") {
                                walk(m.target);
                            }
                        }
                    });

                    observer.observe(document.body, {
                        childList: true,
                        subtree: true,
                        characterData: true
                    });

                    // очистка при закрытии страницы
                    window.addEventListener("beforeunload", () => observer.disconnect());
                })();
            `;

            document.body.appendChild(script);
        }

        // Запуск после загрузки страницы
        ctx.dom.onReady(() => {
            injectTranslation();
        });

        // Небольшой индикатор в трее (опционально)
        const tray = ctx.newTray({
            tooltipText: "Русский перевод активен",
            iconUrl: "https://img.icons8.com/fluency/48/russia-circular.png"
        });

        tray.render(() => tray.text("RU"));

    });
}
